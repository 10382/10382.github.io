{"title":"FFmpeg将mkv带字幕转mp4","slug":"FFmpeg将mkv带字幕转mp4","date":"2019-04-17T14:07:08.000Z","updated":"2019-04-20T01:17:56.560Z","comments":true,"excerpt":"","content":"<!-- # FFmpeg将mkv带字幕转mp4 -->\n<h2 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h2><p>需要将 mkv 视频转成 mp4 文件放到 iOS 的暴风影音软件里看</p>\n<h2 id=\"处理方案\"><a href=\"#处理方案\" class=\"headerlink\" title=\"处理方案\"></a>处理方案</h2><h3 id=\"软字幕\"><a href=\"#软字幕\" class=\"headerlink\" title=\"软字幕\"></a>软字幕</h3><p>MP4 格式支持流文字格式字幕，播放时可在播放器中选择对应的字幕，但该软字幕功能可能在有些播放器或者设备上不支持。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ffmpeg -i input.mkv -map 0:v:0 -map 0:a:1 -map 0:s:34 -c:v copy -c:a copy -c:s mov_text -metadata:s:s:0 language=chs output.mp4</span><br></pre></td></tr></table></figure>\n<p>相关参数: </p>\n<ul>\n<li><code>-map</code> 选项可将你想选择的原mkv文件中的视频流 (<code>v</code>) /音频流 (<code>a</code>) / 字幕流 (<code>s</code>) 复制到输出中；<code>:</code> 后的数字代表原mkv文件中的第几个流（mkv 里有多个音频流/字幕流）。<ul>\n<li>本例中选择了第0个视频流（默认），第1个音频流，第34个字幕流（简体中文）。</li>\n</ul>\n</li>\n<li><code>-c</code> 选项则代编解码器名称，<code>:</code> 后的 <code>v/a/s</code> 意义同上；<ul>\n<li>在本例中视频和音频的编解码器直接复制的原视频音频流的编码器，所以编码器设置的为 <code>copy</code> 。</li>\n<li>而 <code>mov_text</code> 则为此类软字幕编码器</li>\n</ul>\n</li>\n<li><code>-metadata</code> 选项可设置视频的元数据信息，之后的 <code>:s:s:0</code> 为可选项，空格之后接一个要设置元信息的键值对。<ul>\n<li>本例中的 <code>:s:0</code> 表示对<strong>输出文件</strong>第0个字幕流进行元信息的设置，将字幕标识为简体中文。</li>\n<li>如果要设置第0个视频流的元信息，则在 <code>-metadata</code> 之后加 <code>:s:a:0</code></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"外挂字幕\"><a href=\"#外挂字幕\" class=\"headerlink\" title=\"外挂字幕\"></a>外挂字幕</h3><p>尴尬的是 iOS 版的暴风影音不支持 <code>mov_text</code> 编码的软字幕，那就只能尝试能不能用外挂字幕了。</p>\n<p>直接通过 <code>-map</code> 选项将简体中文字幕流导出到 <code>output.srt</code> 文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ffmpeg -i input.mkv -map 0:s:34 output.srt</span><br></pre></td></tr></table></figure>\n<p>在暴风影音中选择这个 <code>output.srt</code> 文件，显示出来却是乱码，然而在电脑上的播放器上却一切正常，这暴风影音真的是不行啊。</p>\n<h3 id=\"硬字幕\"><a href=\"#硬字幕\" class=\"headerlink\" title=\"硬字幕\"></a>硬字幕</h3><h4 id=\"字幕文件嵌入视频\"><a href=\"#字幕文件嵌入视频\" class=\"headerlink\" title=\"字幕文件嵌入视频\"></a>字幕文件嵌入视频</h4><p>将刚才导出的 srt 文件”烧入”到先前生成的那个 <code>output.mp4</code> 文件中，因为此处要对有字幕的视频帧进行压制，所以会比较慢。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ffmpeg -i output.mp4 -vf subtitles=output.srt output-Subtitles.mp4</span><br></pre></td></tr></table></figure>\n<p><code>-vf</code> 选项代表使用视频过滤器 (Video Filters)</p>\n<ul>\n<li><code>subtitles</code> 就代表设置字幕为 <code>=</code> 之后接的字幕文件 / 流</li>\n<li>如果需要嵌入的是 ass 格式的字幕，只需要将 <code>subtitles</code> 替换为 <code>ass</code> ，然后 <code>=</code> 之后接上 ass 字幕文件即可，例如 <code>ffmpeg -i output.mp4 -vf ass=subtitle.ass output-Subtitles.mp4</code></li>\n</ul>\n<p>这次生成的 mp4 文件终于能在暴风影音里播放了，真是够折腾的……</p>\n<h4 id=\"视频字幕流嵌入视频\"><a href=\"#视频字幕流嵌入视频\" class=\"headerlink\" title=\"视频字幕流嵌入视频\"></a>视频字幕流嵌入视频</h4><p>但我不想生成中间的 srt 字幕文件，我们可以直接将 mkv 的字幕流在转成 mp4 的时候直接压制进视频文件中</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ffmpeg -i input.mkv -filter_complex <span class=\"string\">\"[0:v:0]subtitles=input.mkv:si=34[v]\"</span> -map <span class=\"string\">\"[v]\"</span> -map 0:a:0 -c:a copy output.mp4</span><br></pre></td></tr></table></figure>\n<p>此处使用复杂图像过滤器 (Complex filtergraphs) 选项 <code>-filter_complex</code> 来处理视频，将第0个视频流加上 <code>input.mkv</code> 中的第34个字幕流一起压制到视频流 <code>v</code> 中，同时通过 <code>-map</code> 选项将第0个音频流直接导出到 <code>output.mp4</code> 中。</p>\n<p>自此，又能完美的在 iOS 端的暴风影音上愉快地追剧了 d(`･∀･)b</p>\n<p>参考链接</p>\n<ol>\n<li><a href=\"https://askubuntu.com/questions/214199/how-do-i-add-and-or-keep-subtitles-when-converting-video/214351\" target=\"_blank\" rel=\"noopener\">How do I add and/or keep subtitles when converting video? - AskUbuntu</a></li>\n<li><a href=\"http://blog.topspeedsnail.com/archives/5204\" target=\"_blank\" rel=\"noopener\">使用FFmpeg将字幕嵌入到视频 - WTF Daily Blog</a></li>\n<li><a href=\"https://ffmpeg.org/ffmpeg-filters.html#subtitles-1\" target=\"_blank\" rel=\"noopener\">10.183 subtitles - FFmpeg</a></li>\n<li><a href=\"https://github.com/varenc/homebrew-ffmpeg\" target=\"_blank\" rel=\"noopener\">varenc / homebrew-ffmpeg - Github</a></li>\n</ol>\n","thumbnail":"https://ae01.alicdn.com/kf/HTB1_r79RSzqK1RjSZFpq6ykSXXaK.jpg","categories":[{"name":"Shell","path":"api/categories/Shell.json"}],"tags":[{"name":"ffmpeg","path":"api/tags/ffmpeg.json"}]}